---
knit: (function(input_file, encoding) {
  out_dir <- 'docs/R';
  rmarkdown::render(input_file,
    encoding=encoding,
    output_file='Mann-Whitney.md') })
output: github_document
editor_options:
  chunk_output_type: console
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE,
                      fig.path = "img/Mann-Whitney/",
                      fig.width = 6, fig.height = 4,
                      fig.show = 'hold', fig.align = 'center')
options(width = 100)
```

# Mann-Whitney U & Wilcoxon rank sum tests

### Fitting the Mann-Whitney U test

&emsp;In this example we will use the `mtcars` data set that is provided in base R.  The data set includes 10 aspects of automobile design and performance for 32 automobile models built between 1973 and 1974.  We will specifically be interested in whether there are differences in miles per gallon (*mpg*) between the two types of transmission (*am*), automatic and manual.  Specifying these two columns specifically in the `summary()` function we can get an idea of how each look like.

```{r mtcars_summary}
summary(mtcars[, c("am", "mpg")])
```

&emsp;Because *am* is coded as a number rather than a factor the `summary()` function calculates the mean and quantiles, which are not very useful to us.  For the *mpg* variable we do see that it appears to be continuous and there are no missing data or miscoded values.  Plotting the data as below, we might hypothesize that there is a difference between automatic and manual transmission and the miles per gallon for the automobiles.

```{r mtcars_plot, echo = FALSE}
library(tidyverse)

ggplot(mtcars, aes(x = factor(am), y = mpg, fill = factor(am))) +
  geom_boxplot(width = 0.5, outlier.shape = NA) +
  geom_jitter(size = 2, width = 0.15, alpha = 0.5) +
  scale_fill_brewer(palette = "Paired") +
  labs(title = "Automatic and manual miles per gallon\n for 32 automobiles (1973-74 models)",
       x = "Automatic transmission", y = "Miles per gallon") +
  scale_x_discrete(labels = c("Automatic", "Manual")) +
  theme_bw() +
  theme(legend.position = "NULL",
        plot.title = element_text(hjust = 0.5))
```

&emsp;To statistically determine if there are differences between these two types of transmissions we will use the Mann-Whitney U test.  In R, we can perform a Mann-Whitney test using the `wilcox.test()` function with the continuous variable (*mpg*) on the left and the categorical variable (*mpg*) on the right of the `~`.  We will also set the `conf.int` option to `TRUE` so that the 95% confidence intervale and differences in location are calculated.

```{r mtcars_test, message = TRUE}
wilcox.test(mpg ~ am, data = mtcars, conf.int = TRUE)
```

&emsp;Note that we get warning messages with the output from the test  This is because we have some values with tied rankings and sample sizes lower than 50, which causes the exact p-value and confidence intervals to be unable to be calculated.  There are different ways we can avoid this issue, such as increasing the sample size to 50 or greater, but in many cases that solution would not be feasible.  Instead, the estimated p-value based on a normal approximation calculated by the `wilcox.test()` is good enough, and we can conclude that automobiles with automatic transmissions have a lower miles per gallon than those with manual transmissions.  The median difference between automatic and manual miles per gallon is somewhere between -2.9 and -11.7 mpg with 95% confidence, and the median of the difference between automatic and manual transmissions is -6.8 mpg.

### Fitting the Wilcoxon rank sum test

&emsp;In the case that our data is paired the Mann-Whitney U test is no longer viable.  Instead, we should apply the Wilcoxon rank sum test which in R uses the same `wilcox.test()` function but requires us to set the `paired` option to `TRUE`.

```{r sleep_summary}
summary(sleep)
```

```{r sleep_plot, echo = FALSE}
ggplot(sleep, aes(x = factor(group), y = extra, fill = factor(group))) +
  geom_boxplot(width = 0.5, outlier.shape = NA) +
  geom_jitter(size = 2, width = 0.15, alpha = 0.5) +
  scale_fill_brewer(palette = "OrRd") +
  labs(title = "Effect of two soporific drugs on the hours of sleep for 10 patients",
       x = "Drug provided", y = "Change in hours of sleep") +
  scale_x_discrete(labels = c("Drug #1", "Drug #2")) +
  theme_bw() +
  theme(legend.position = "NULL",
        plot.title = element_text(hjust = 0.5))
```


```{r sleep_test, message = TRUE}
wilcox.test(extra ~ group, sleep, paired = TRUE, conf.int = TRUE)
```

&emsp;Again we see that there are warning messages, this time both that there are ties and that there are 0's in our data set.  Many times this is unavoidable


### Full code block

```{r full_code, eval = FALSE}
# Print summary statistics for the am and mpg variables from the mtcars data set
summary(mtcars[, c("am", "mpg")])

# Perform a Mann-Whitney test with miles per gallon as the dependent and transmission as the
# independent variable
wilcox.test(mpg ~ am, data = mtcars, conf.int = TRUE)

# Print summary statistics for the sleep data set
summary(sleep)

# Perform a Wilcoxon rank sum test with the change in hours of sleep as the dependent and the
# type of trug as the independent variable
wilcox.test(extra ~ group, sleep, paired = TRUE, conf.int = TRUE)
```

